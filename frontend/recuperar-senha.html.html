<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIPC - Recuperar Senha</title>
    <link rel="stylesheet" href="assets/css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .step-container {
            display: none;
        }
        .step-container.active {
            display: block;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .code-input {
            text-align: center;
            font-size: 24px;
            letter-spacing: 8px;
            font-weight: bold;
        }
        .back-link {
            text-align: center;
            margin-top: 20px;
        }
        .back-link a {
            color: #1ABC9C;
            text-decoration: none;
            font-size: 14px;
        }
        .back-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <i class="fas fa-microchip"></i>
                </div>
                <h1>SIPC</h1>
                <p>Recuperação de Senha</p>
            </div>

            <div id="error-message" class="error-message" style="display: none;">
                Erro ao processar solicitação
            </div>

            <div id="success-message" class="success-message">
                Mensagem de sucesso
            </div>

            <!-- Step 1: Request email -->
            <div id="step1" class="step-container active">
                <p style="text-align: center; margin-bottom: 20px; color: #666;">
                    Digite seu e-mail para receber o código de recuperação
                </p>
                
                <form id="emailForm" class="login-form">
                    <div class="form-group">
                        <label for="email">E-mail:</label>
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                placeholder="seu@sipc.com"
                                required
                                autocomplete="email"
                            >
                        </div>
                    </div>

                    <button type="submit" class="login-btn">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Código
                    </button>
                </form>
            </div>

            <!-- Step 2: Enter code and new password -->
            <div id="step2" class="step-container">
                <p style="text-align: center; margin-bottom: 20px; color: #666;">
                    Digite o código enviado para seu e-mail e sua nova senha
                </p>
                
                <form id="resetForm" class="login-form">
                    <div class="form-group">
                        <label for="codigo">Código de Verificação:</label>
                        <div class="input-group">
                            <i class="fas fa-key"></i>
                            <input 
                                type="text" 
                                id="codigo" 
                                name="codigo" 
                                placeholder="000000"
                                required
                                maxlength="6"
                                class="code-input"
                            >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="novaSenha">Nova Senha:</label>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input 
                                type="password" 
                                id="novaSenha" 
                                name="novaSenha" 
                                placeholder="••••••••"
                                required
                                minlength="6"
                            >
                            <button type="button" id="toggleNewPassword" class="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmarSenha">Confirmar Nova Senha:</label>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input 
                                type="password" 
                                id="confirmarSenha" 
                                name="confirmarSenha" 
                                placeholder="••••••••"
                                required
                                minlength="6"
                            >
                            <button type="button" id="toggleConfirmPassword" class="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="login-btn">
                        <i class="fas fa-check"></i>
                        Alterar Senha
                    </button>
                </form>

                <div class="back-link">
                    <a href="#" id="backToStep1">
                        <i class="fas fa-arrow-left"></i>
                        Voltar para inserir e-mail
                    </a>
                </div>
            </div>

            <div class="back-link">
                <a href="login.html">
                    <i class="fas fa-arrow-left"></i>
                    Voltar ao Login
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let userEmail = '';
            
            // Toggle password visibility functions
            function setupPasswordToggle(toggleId, inputId) {
                const toggle = document.getElementById(toggleId);
                const input = document.getElementById(inputId);
                
                if (toggle && input) {
                    toggle.addEventListener('click', function() {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        
                        const icon = toggle.querySelector('i');
                        if (type === 'password') {
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        } else {
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        }
                    });
                }
            }
            
            setupPasswordToggle('toggleNewPassword', 'novaSenha');
            setupPasswordToggle('toggleConfirmPassword', 'confirmarSenha');
            
            // Step navigation
            function showStep(stepNumber) {
                document.querySelectorAll('.step-container').forEach(step => {
                    step.classList.remove('active');
                });
                document.getElementById(`step${stepNumber}`).classList.add('active');
            }
            
            // Back to step 1
            document.getElementById('backToStep1').addEventListener('click', function(e) {
                e.preventDefault();
                showStep(1);
                document.getElementById('email').value = userEmail;
            });
            
            // Handle email form submission
            document.getElementById('emailForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();
                
                if (!email) {
                    showError('Por favor, digite seu e-mail.');
                    return;
                }
                
                try {
                    const submitBtn = this.querySelector('.login-btn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                    submitBtn.disabled = true;
                    
                    const response = await fetch('/api/auth/forgot-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        userEmail = email;
                        showSuccess('Código enviado para seu e-mail!');
                        setTimeout(() => {
                            showStep(2);
                            document.getElementById('codigo').focus();
                        }, 2000);
                    } else {
                        showError(data.message || 'E-mail não encontrado.');
                    }
                } catch (error) {
                    console.error('Erro ao solicitar recuperação:', error);
                    showError('Erro de conexão. Tente novamente.');
                } finally {
                    const submitBtn = this.querySelector('.login-btn');
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Código';
                    submitBtn.disabled = false;
                }
            });
            
            // Handle reset form submission
            document.getElementById('resetForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const codigo = document.getElementById('codigo').value.trim();
                const novaSenha = document.getElementById('novaSenha').value;
                const confirmarSenha = document.getElementById('confirmarSenha').value;
                
                if (!codigo || !novaSenha || !confirmarSenha) {
                    showError('Por favor, preencha todos os campos.');
                    return;
                }
                
                if (novaSenha !== confirmarSenha) {
                    showError('As senhas não coincidem.');
                    return;
                }
                
                if (novaSenha.length < 6) {
                    showError('A senha deve ter pelo menos 6 caracteres.');
                    return;
                }
                
                try {
                    const submitBtn = this.querySelector('.login-btn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Alterando...';
                    submitBtn.disabled = true;
                    
                    const response = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            email: userEmail,
                            codigo,
                            novaSenha 
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showSuccess('Senha alterada com sucesso!');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    } else {
                        showError(data.message || 'Código inválido ou expirado.');
                    }
                } catch (error) {
                    console.error('Erro ao alterar senha:', error);
                    showError('Erro de conexão. Tente novamente.');
                } finally {
                    const submitBtn = this.querySelector('.login-btn');
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Alterar Senha';
                    submitBtn.disabled = false;
                }
            });
            
            // Utility functions
            function showError(message) {
                const errorElement = document.getElementById('error-message');
                const successElement = document.getElementById('success-message');
                
                successElement.style.display = 'none';
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
            
            function showSuccess(message) {
                const errorElement = document.getElementById('error-message');
                const successElement = document.getElementById('success-message');
                
                errorElement.style.display = 'none';
                successElement.textContent = message;
                successElement.style.display = 'block';
                
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 5000);
            }
            
            // Focus on email input
            document.getElementById('email').focus();
        });
    </script>
</body>
</html>
